# はじめに

## etcdとは

etcdは分散型のキーバリューストアです。
etcdはもともと複数のマシンが協調しながら1台ずつ再起動する際に合意を取るための仕組みとして、CoreOS社[^1]によって開発されていました。
etcdはその手軽さから様々ななソフトウェアのバックエンドとして採用されていましたが、Kubernetesのバックエンドに採用されたことで広く注目されるようになり、コミュニティの規模も大きくなりました。
2018年12月にはCNCFに寄贈され、現在はオープンソースコミュニティにおいて活発に開発が進められています。

[^1]: CoreOS社は2018年にRed Hat社に買収されました。

etcdには以下のような特徴があります。

* 高可用性(High Availability)
  etcdは高可用な構成でクラスタを構築することができます。
  例えば5台のサーバーを使ってetcdクラスタを構築した場合、最大2台のサーバーが故障したとしてもクラスタの機能を正常に提供し続けることが可能です。

* 強い一貫性(Strong Consistency)
  etcdは強い一貫性モデルを採用しています。
  これはetcdクラスタに対してデータの書き込みに成功すると、その後にそのデータを読み出した場合は必ず書き込んだ値が読み込まれるということです。
  この特徴は当たり前に聞こえるかもしれませんが、分散キーバリューストアの中には強い一貫性を持たないものも存在します。
  例えば結果整合性(Eventually Consistency)を持つデータベースは、書き込んだ値はそのうち反映されればよいという考えです。
  その代わりにスケールアウトさせることで非常に高いパフォーマンスを実現することが可能になっています。
  一方で強い一貫性モデルを採用しているetcdは、スケールアウトさせてパフォーマンスを向上させることはできません。

etcdはRaftと呼ばれる分散合意(Consensus)アルゴリズムに基づいて実装されています。
Raftでは、クラスタの中からリーダーを選出する方法、ログ(データの変更イベント)をクラスタ内のメンバーに複製する方法、ネットワーク障害やメンバーの故障が発生したときにもそれらを安全におこなう方法が定められています。
このアルゴリズムを正しく実装することで、ネットワーク障害などが発生しても、リーダーがクラスタ内にたかだか1つしか存在しないこと、ログの順序が入れ替わらないこと、データが不整合を起こさないことが保証されており、高い信頼性を実現することができます。
Raftは理解しやすいことを重視しており、Paxosなど他の分散合意アルゴリズムと比べてシンプルで実装しやすくなっています。

また、etcdはキーバリューの読み書きだけでなく、Watch(値の変更監視)、Lease(キーの有効期限)、Leader Electionなどの機能を提供しています。
これらの機能は分散システムを開発するときに非常に便利なものばかりです。

一方でetcdには不得意な分野もあります。
大きなデータは取り扱うことができず(クラスタ全体で扱えるデータサイズはデフォルトで2GB、最大8GB、1レコードのサイズは最大1.5MB)、メンバーの数を増やしても性能を向上させることはできないため、大容量のデータを高速に扱うような用途には向いていません。

本書では、Go言語を利用してetcdの機能を利用するプログラミング手法を解説します。

### 本書が対象とするGoとetcdのバージョン

本書では2020年9月現在の最新版である下記のバージョンに基づいて解説をおこないます。
異なるバージョンでは挙動が違う場合もあるので注意してください。

* Go: 1.15.2
* etcd: 3.4.13

### サンプルプログラム

本書で解説するサンプルプログラムは下記のページで公開しています。

* https://github.com/zoetrope/etcd-programming

### 更新履歴

* 2021: English edition
* 2020/09/25: Support for etcd 3.4
* 2019/11/24: First release
